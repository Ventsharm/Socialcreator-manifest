<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Budget Planner</title>
<link rel="icon" href="Icon-192.png" />
<style>
  :root{
    --bg:#f5f6f8; --card:#ffffff; --text:#111; --muted:#667085; --ring:#dcdfe6;
    --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px; --btnr:12px;
    --soft-blue:#eef5ff; --soft-purple:#f3efff; --soft-orange:#fff3e8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  .btn{
    background:#fff; color:#000; border:1.6px solid #000; border-radius:var(--btnr);
    padding:10px 14px; font-weight:800; cursor:pointer; transition:transform .06s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.sm{padding:8px 12px; font-weight:700}

  .auth-screen{
    position:fixed; inset:0; background:#fff; display:flex; align-items:center; justify-content:center; padding:20px; z-index:50;
  }
  .auth-card{width:min(520px,96vw); border:1px solid var(--ring); border-radius:22px; box-shadow:var(--shadow); background:#fff; padding:20px}
  .auth-title{font-size:24px; font-weight:900; text-align:center; margin:4px 0 14px}
  .auth-tabs{display:flex; gap:8px; justify-content:center; margin:4px 0 14px}
  .auth-tabs .btn{border-radius:999px}
  .auth-view{display:none}
  .auth-view.active{display:block}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  label{font-weight:800; color:#333}
  input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="date"]{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); background:#fff; outline:none;
  }
  input:focus{box-shadow:0 0 0 4px rgba(0,0,0,.06)}

  .app{display:none; width:min(950px,96vw); margin:24px auto; background:#fff; border:1px solid var(--ring); border-radius:22px; box-shadow:var(--shadow); overflow:hidden}
  .topbar{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--ring); background:#fff}
  .brand{font-size:20px; font-weight:900}
  .userbox{display:flex; flex-direction:column; align-items:flex-end; gap:10px; color:#555; flex-wrap:wrap}

  .tabs{display:flex; gap:10px; padding:12px 14px; border-bottom:1px solid var(--ring); background:#fff}
  .tab{flex:1; text-align:center; padding:10px 12px; border-radius:999px; border:1.6px solid #000; background:#fff; font-weight:800; cursor:pointer}
  .tab[aria-selected="true"]{box-shadow:0 0 0 2px #000 inset}

  .content{padding:16px; display:grid; gap:14px}
  .card{background:#fff; border:1px solid var(--ring); border-radius:var(--radius); padding:16px}
  h2.section{margin:2px 0 12px; font-size:1.1rem; font-weight:900}
  .btnrow{display:grid; grid-template-columns:1fr 1fr; gap:10px}

  .list{display:flex; flex-direction:column; gap:10px; margin-top:12px}
  .item{border:1px solid var(--ring); border-radius:14px; background:#fff; padding:12px}
  .item_head{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; cursor:pointer}
  .item_title{font-weight:900}
  .item_amount{font-weight:900}
  .item_actions{display:none; gap:8px; margin-top:10px; padding-top:10px; border-top:1px dashed #e5e6ee; animation:reveal .18s ease}
  .item.show .item_actions{display:flex}
  @keyframes reveal{from{opacity:0; transform:translateY(-4px)} to{opacity:1; transform:none}}

  .include-pill{font-weight:900; color:#16a34a}
  .kpi{border:1px solid var(--ring); border-radius:16px; padding:16px; margin-bottom:12px; background:#fff}
  .kpi.blue{background:var(--soft-blue)}
  .kpi.purple{background:var(--soft-purple)}
  .kpi.orange{background:var(--soft-orange)}
  .kpi.green{background:#eafbe7}
  .kpi .k{font-size:.92rem; color:#555; font-weight:800; margin-bottom:6px}
  .kpi .v{font-size:1.6rem; font-weight:900}

  .footer{padding:10px 16px; color:#777; border-top:1px solid var(--ring); text-align:center}

  dialog::backdrop{background:rgba(0,0,0,.35)}
  dialog{border:0; border-radius:18px; padding:0; width:min(520px,92vw); box-shadow:var(--shadow); background:#fff}
  .modal{padding:18px}
  .modal h3{margin:0 0 12px}
  .modal .actions{display:flex; gap:10px; margin-top:12px}
  .center-row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}

  .offline-pop{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:#fff; border:1px solid #000;
    border-radius:12px; padding:12px 14px; box-shadow:var(--shadow); display:none; z-index:60}
</style>
</head>
<body>

<!-- Auth, App shell, etc. unchanged (same as your working version) -->

<!-- Incomes -->
<section class="card" id="view-incomes" aria-labelledby="tab-inc">
  <h2 class="section">Income Sources</h2>
  <div class="row">
    <input id="inc-name" type="text" placeholder="Income name e.g. Salary / Benefit" />
    <input id="inc-amt" type="number" min="0" step="0.01" placeholder="Amount e.g. 1200" />
  </div>
  <div class="row" style="margin-top:8px">
    <label style="font-weight:800">Date Received</label>
    <input id="inc-date" type="date" />
  </div>
  <div class="center-row" style="margin-top:8px">
    <span style="color:#444; font-weight:800">Include in available income:</span>
    <input id="inc-include" type="checkbox" />
  </div>
  <div class="btnrow" style="margin-top:10px">
    <button id="add-inc" class="btn">Add Income</button>
    <button id="reset-inc" class="btn">Reset</button>
  </div>
  <div id="inc-list" class="list"></div>
</section>

<!-- Expenses -->
<section class="card" id="view-expenses" aria-labelledby="tab-exp" style="display:none">
  <h2 class="section">Expenses</h2>
  <div class="row">
    <input id="exp-name" type="text" placeholder="Bill e.g. Rent / Spotify" />
    <input id="exp-amt" type="number" min="0" step="0.01" placeholder="Amount e.g. 500" />
  </div>
  <div class="row" style="margin-top:8px">
    <label style="font-weight:800">Bill Date</label>
    <input id="exp-date" type="date" />
  </div>
  <div class="btnrow" style="margin-top:10px">
    <button id="add-exp" class="btn">Add Bill</button>
    <button id="reset-exp" class="btn">Reset</button>
  </div>
  <div id="exp-list" class="list"></div>
</section>

<!-- Overview -->
<section class="card" id="view-overview" aria-labelledby="tab-ovw" style="display:none">
  <h2 class="section">Overview</h2>
  <div class="kpi blue">
    <div class="k">Total Income (All)</div>
    <div id="ovw-total" class="v">£0.00</div>
  </div>
  <div class="kpi purple">
    <div class="k">Available Income (Included − Expenses)</div>
    <div id="ovw-available" class="v">£0.00</div>
  </div>
  <div class="kpi orange">
    <div class="k">Expenses</div>
    <div id="ovw-exp" class="v">£0.00</div>
  </div>
  <div class="kpi green">
    <div class="k">Remaining to Pay</div>
    <div id="ovw-remaining" class="v">£0.00</div>
  </div>
</section><!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
const $ = s => document.querySelector(s);
const fmt = n => "£" + (Number(n||0)).toFixed(2);

const firebaseConfig = {
  apiKey: "AIzaSyCdqBDusmELyZ6S6OeiUX_I_POjydy-dN4",
  authDomain: "budget-app-283de.firebaseapp.com",
  projectId: "budget-app-283de",
  storageBucket: "budget-app-283de.firebasestorage.app",
  messagingSenderId: "162369707369",
  appId: "1:162369707369:web:3faa7f002f8ba22dc0f1f8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
firebase.firestore().enablePersistence({synchronizeTabs:true}).catch(()=>{});

const appShell=$("#app"),authPage=$("#authPage"),verifyBox=$("#verifyBox");
const userEmail=$("#userEmail"),btnLogout=$("#btnLogout");

const tabInc=$("#tab-inc"),tabExp=$("#tab-exp"),tabOvw=$("#tab-ovw");
const viewIncomes=$("#view-incomes"),viewExpenses=$("#view-expenses"),viewOverview=$("#view-overview");

const incName=$("#inc-name"),incAmt=$("#inc-amt"),incDate=$("#inc-date"),incInc=$("#inc-include");
const addInc=$("#add-inc"),resetInc=$("#reset-inc"),incList=$("#inc-list");

const expName=$("#exp-name"),expAmt=$("#exp-amt"),expDate=$("#exp-date");
const addExp=$("#add-exp"),resetExp=$("#reset-exp"),expList=$("#exp-list");

const ovwTotal=$("#ovw-total"),ovwAvail=$("#ovw-available"),ovwExp=$("#ovw-exp"),ovwRemain=$("#ovw-remaining");

let user=null;
let state={incomes:[],expenses:[]};
const LCKEY=uid=>`bp-cache:${uid}`;
const readCache=uid=>{try{return JSON.parse(localStorage.getItem(LCKEY(uid))||'{"incomes":[],"expenses":[]}');}catch{return{incomes:[],expenses:[]}}};
const writeCache=(uid,data)=>localStorage.setItem(LCKEY(uid),JSON.stringify(data));

function showTab(w){
  tabInc.setAttribute("aria-selected",w==="incomes");
  tabExp.setAttribute("aria-selected",w==="expenses");
  tabOvw.setAttribute("aria-selected",w==="overview");
  viewIncomes.style.display=w==="incomes"?"":"none";
  viewExpenses.style.display=w==="expenses"?"":"none";
  viewOverview.style.display=w==="overview"?"":"none";
}
tabInc.onclick=()=>showTab("incomes");
tabExp.onclick=()=>showTab("expenses");
tabOvw.onclick=()=>showTab("overview");

const base=uid=>db.collection("users").doc(uid);
async function pullOnce(){
  if(!user)return;
  const incSnap=await base(user.uid).collection("incomes").get();
  const expSnap=await base(user.uid).collection("expenses").get();
  state.incomes=incSnap.docs.map(d=>({id:d.id,...d.data()}));
  state.expenses=expSnap.docs.map(d=>({id:d.id,...d.data()}));
  writeCache(user.uid,state);
  renderAll();
}
function addDocFS(type,data){
  const id=db.collection("_").doc().id;
  state[type].push({id,...data});
  renderAll();writeCache(user.uid,state);
  base(user.uid).collection(type).doc(id).set(data).catch(console.warn);
}
function updateDocFS(type,id,patch){
  const i=state[type].findIndex(x=>x.id===id);
  if(i>-1)state[type][i]={...state[type][i],...patch};
  renderAll();writeCache(user.uid,state);
  base(user.uid).collection(type).doc(id).update(patch).catch(console.warn);
}
function deleteDocFS(type,id){
  state[type]=state[type].filter(x=>x.id!==id);
  renderAll();writeCache(user.uid,state);
  base(user.uid).collection(type).doc(id).delete().catch(console.warn);
}

function renderAll(){
  incList.innerHTML="";
  state.incomes.forEach(doc=>{
    const el=document.createElement("div");
    const dateLabel=doc.date?`<div style='color:#777;font-size:.9em'>${doc.date}</div>`:"";
    el.className="item";
    el.innerHTML=`
      <div class="item_head" data-type="incomes" data-id="${doc.id}">
        <div class="include-pill">${doc.include?"✅":""}</div>
        <div class="item_title">${doc.title}${dateLabel}</div>
        <div class="item_amount">${fmt(doc.amount)}</div>
      </div>
      <div class="item_actions">
        <button class="btn" data-act="edit" data-type="incomes" data-id="${doc.id}">Edit</button>
        <button class="btn" data-act="del" data-type="incomes" data-id="${doc.id}">Delete</button>
      </div>`;
    incList.appendChild(el);
  });

  expList.innerHTML="";
  state.expenses.forEach(doc=>{
    const el=document.createElement("div");
    const dateLabel=doc.date?`<div style='color:#777;font-size:.9em'>${doc.date}</div>`:"";
    const paidLabel=doc.paid?"(Paid)":"";
    el.className="item";
    el.innerHTML=`
      <div class="item_head" data-type="expenses" data-id="${doc.id}">
        <div class="include-pill" style="visibility:hidden">.</div>
        <div class="item_title">${doc.title} ${paidLabel}${dateLabel}</div>
        <div class="item_amount">${fmt(doc.amount)}</div>
      </div>
      <div class="item_actions">
        <button class="btn" data-act="edit" data-type="expenses" data-id="${doc.id}">Edit</button>
        <button class="btn" data-act="del" data-type="expenses" data-id="${doc.id}">Delete</button>
        <button class="btn" data-act="paid" data-type="expenses" data-id="${doc.id}">
          ${doc.paid?"Unmark Paid":"Mark Paid"}
        </button>
      </div>`;
    expList.appendChild(el);
  });

  document.querySelectorAll(".item").forEach(row=>{
    row.querySelector(".item_head").onclick=()=>row.classList.toggle("show");
  });
  document.querySelectorAll(".item_actions .btn").forEach(b=>{
    b.onclick=()=>{
      const act=b.dataset.act,type=b.dataset.type,id=b.dataset.id;
      if(act==="edit")openEdit(type,id);
      if(act==="del"&&confirm("Delete this item?"))deleteDocFS(type,id);
      if(act==="paid")togglePaid(id);
    };
  });

  const totalAll=state.incomes.reduce((s,x)=>s+Number(x.amount||0),0);
  const totalInc=state.incomes.filter(x=>x.include).reduce((s,x)=>s+Number(x.amount||0),0);
  const totalExp=state.expenses.reduce((s,x)=>s+Number(x.amount||0),0);
  const totalPaid=state.expenses.filter(x=>x.paid).reduce((s,x)=>s+Number(x.amount||0),0);
  ovwTotal.textContent=fmt(totalAll);
  ovwAvail.textContent=fmt(totalInc-totalExp);
  ovwExp.textContent=fmt(totalExp);
  ovwRemain.textContent=fmt(totalExp-totalPaid);
}

function togglePaid(id){
  const e=state.expenses.find(x=>x.id===id);
  if(!e)return;
  updateDocFS("expenses",id,{paid:!e.paid});
}

let editing={type:null,id:null};
const editModal=$("#editModal"),editTitle=$("#editTitle"),editName=$("#edit-name"),
      editAmount=$("#edit-amt"),editInclude=$("#edit-include"),editIncWrap=$("#edit-include-wrap"),
      editSave=$("#edit-save"),editCancel=$("#edit-cancel");
function openEdit(type,id){
  const src=state[type].find(x=>x.id===id);if(!src)return;
  editing={type,id};
  editTitle.textContent=type==="incomes"?"Edit Income":"Edit Expense";
  editName.value=src.title;editAmount.value=src.amount;
  if(type==="incomes"){editIncWrap.style.display="flex";editInclude.checked=!!src.include;}
  else{editIncWrap.style.display="none";}
  editModal.showModal();
}
editCancel.onclick=()=>editModal.close();
editSave.onclick=()=>{
  const name=editName.value.trim(),amt=parseFloat(editAmount.value);
  if(!name||!isFinite(amt))return alert("Enter valid name and amount.");
  const patch={title:name,amount:amt};
  if(editing.type==="incomes")patch.include=!!editInclude.checked;
  updateDocFS(editing.type,editing.id,patch);
  editModal.close();
};

addInc.onclick=()=>{
  const title=incName.value.trim(),amount=parseFloat(incAmt.value);
  if(!title||!isFinite(amount))return alert("Enter valid name and amount.");
  addDocFS("incomes",{title,amount,include:!!incInc.checked,date:incDate.value});
  incName.value="";incAmt.value="";incDate.value="";incInc.checked=false;
};
resetInc.onclick=()=>{incName.value="";incAmt.value="";incDate.value="";incInc.checked=false;};

addExp.onclick=()=>{
  const title=expName.value.trim(),amount=parseFloat(expAmt.value);
  if(!title||!isFinite(amount))return alert("Enter valid name and amount.");
  addDocFS("expenses",{title,amount,date:expDate.value,paid:false});
  expName.value="";expAmt.value="";expDate.value="";
};
resetExp.onclick=()=>{expName.value="";expAmt.value="";expDate.value="";};

btnLogout.onclick=async()=>{await auth.signOut();};

auth.onAuthStateChanged(async(u)=>{
  user=u;
  if(!u){authPage.style.display="flex";appShell.style.display="none";return;}
  if(!u.emailVerified){authPage.style.display="flex";verifyBox.style.display="flex";appShell.style.display="none";return;}
  authPage.style.display="none";verifyBox.style.display="none";appShell.style.display="block";
  userEmail.textContent=u.email;btnLogout.style.display="inline-block";
  state=readCache(u.uid);if(!state.incomes)state={incomes:[],expenses:[]};renderAll();
  if(!localStorage.getItem(LCKEY(u.uid)))await pullOnce();
});
</script>
</body>
</html>
