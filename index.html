<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget Planner</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f6f8;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .app {
      background: white;
      width: 95%;
      max-width: 400px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h2 {
      text-align: center;
      margin-top: 0;
      font-weight: 700;
      font-size: 1.5em;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 15px;
    }
    .tab {
      flex: 1;
      padding: 10px;
      border: none;
      background: #eee;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    .tab.active {
      background: #007bff;
      color: white;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
    }
    .add-btn {
      background: black;
      color: white;
    }
    .reset-btn {
      background: #e5e5e5;
      color: black;
    }
    .logout-btn {
      background: #ccc;
      color: black;
      margin-top: 10px;
    }
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f9f9f9;
      margin: 5px 0;
      padding: 10px;
      border-radius: 10px;
    }
    .edit-btn {
      background: #007bff;
      color: white;
      width: 48%;
    }
    .delete-btn {
      background: #ff3b30;
      color: white;
      width: 48%;
    }
    .overview-card {
      background: #fdfdfd;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 10px;
      text-align: center;
    }
    .overview-card:nth-child(1) { color: #007bff; }
    .overview-card:nth-child(2) { color: #7e3ff2; }
    .overview-card:nth-child(3) { color: #ff3b30; }
    .login-box {
      text-align: center;
    }
    .login-box input {
      width: 100%;
      margin: 5px 0;
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 15px;
      width: 85%;
      max-width: 350px;
    }
  </style>
</head>
<body>

  <div class="app" id="app">
    <h2>Budget Planner</h2>
    <p id="userEmail" style="text-align:center;font-size:0.9em;color:#555;"></p>

    <div class="tabs">
      <button class="tab active" id="incomesTab">Incomes</button>
      <button class="tab" id="expensesTab">Expenses</button>
      <button class="tab" id="overviewTab">Overview</button>
    </div>

    <div id="incomesSection" class="section">
      <h3>Income Sources</h3>
      <input id="incomeTitle" placeholder="Income name e.g. Cashier or Benefit">
      <input id="incomeAmount" type="number" placeholder="Amount e.g. 1200">
      <label><input type="checkbox" id="incomeInclude"> Include in available income</label>
      <button class="add-btn" id="addIncomeBtn">Add Income</button>
      <div id="incomesList"></div>
    </div>

    <div id="expensesSection" class="section" style="display:none;">
      <h3>Expenses</h3>
      <input id="expenseTitle" placeholder="Bill / Subscription e.g. Rent or Spotify">
      <input id="expenseAmount" type="number" placeholder="Amount e.g. 500">
      <button class="add-btn" id="addExpenseBtn">Add Bill</button>
      <div id="expensesList"></div>
    </div>

    <div id="overviewSection" class="section" style="display:none;">
      <div class="overview-card"><h4>Total Income (All)</h4><p id="totalIncome">£0.00</p></div>
      <div class="overview-card"><h4>Available Income (Included - Expenses)</h4><p id="availableIncome">£0.00</p></div>
      <div class="overview-card"><h4>Expenses</h4><p id="totalExpenses">£0.00</p></div>
    </div>

    <button class="logout-btn" id="logoutBtn">Logout</button>
    <p style="text-align:center;font-size:0.8em;color:#777;">Synced via Firebase. Cached offline; 0 reads on refresh.</p>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3 id="editTitle">Edit Item</h3>
      <input id="editName">
      <input id="editValue" type="number">
      <label><input type="checkbox" id="editInclude"> Include in available</label>
      <button class="add-btn" id="saveEdit">Save</button>
      <button class="reset-btn" id="cancelEdit">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdqBDusmELyZ6S6OeiUX_I_POjydy-dN4",
      authDomain: "budget-app-283de.firebaseapp.com",
      projectId: "budget-app-283de",
      storageBucket: "budget-app-283de.appspot.com",
      messagingSenderId: "162369707369",
      appId: "1:162369707369:web:3faa7f002f8ba22dc0f1f8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Sections toggle
    const sections = {
      incomes: document.getElementById('incomesSection'),
      expenses: document.getElementById('expensesSection'),
      overview: document.getElementById('overviewSection'),
    };

    const tabs = {
      incomes: document.getElementById('incomesTab'),
      expenses: document.getElementById('expensesTab'),
      overview: document.getElementById('overviewTab'),
    };

    Object.keys(tabs).forEach(tab => {
      tabs[tab].addEventListener('click', () => {
        Object.keys(sections).forEach(s => {
          sections[s].style.display = (s === tab) ? 'block' : 'none';
          tabs[s].classList.toggle('active', s === tab);
        });
      });
    });

    // Dummy offline demo (localStorage-based)
    let incomes = JSON.parse(localStorage.getItem('incomes') || '[]');
    let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');

    const incomeList = document.getElementById('incomesList');
    const expenseList = document.getElementById('expensesList');

    function renderLists() {
      incomeList.innerHTML = '';
      expenseList.innerHTML = '';
      incomes.forEach((i, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <span>${i.include ? '✅ ' : ''}${i.title} - £${i.amount.toFixed(2)}</span>
          <div style="display:flex;gap:4px;">
            <button class="edit-btn" onclick="editItem('income',${idx})">Edit</button>
            <button class="delete-btn" onclick="deleteItem('income',${idx})">Delete</button>
          </div>`;
        incomeList.appendChild(div);
      });
      expenses.forEach((e, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <span>${e.title} - £${e.amount.toFixed(2)}</span>
          <div style="display:flex;gap:4px;">
            <button class="edit-btn" onclick="editItem('expense',${idx})">Edit</button>
            <button class="delete-btn" onclick="deleteItem('expense',${idx})">Delete</button>
          </div>`;
        expenseList.appendChild(div);
      });
      updateOverview();
    }

    function updateOverview() {
      const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
      const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
      const available = incomes.filter(i => i.include).reduce((sum, i) => sum + i.amount, 0) - totalExpenses;
      document.getElementById('totalIncome').textContent = `£${totalIncome.toFixed(2)}`;
      document.getElementById('totalExpenses').textContent = `£${totalExpenses.toFixed(2)}`;
      document.getElementById('availableIncome').textContent = `£${available.toFixed(2)}`;
    }

    window.editItem = function(type, index) {
      const modal = document.getElementById('editModal');
      modal.style.display = 'flex';
      const editTitle = document.getElementById('editTitle');
      const editName = document.getElementById('editName');
      const editValue = document.getElementById('editValue');
      const editInclude = document.getElementById('editInclude');
      let data = type === 'income' ? incomes[index] : expenses[index];
      editTitle.textContent = type === 'income' ? 'Edit Income' : 'Edit Expense';
      editName.value = data.title;
      editValue.value = data.amount;
      editInclude.checked = !!data.include;
      document.getElementById('saveEdit').onclick = () => {
        data.title = editName.value;
        data.amount = parseFloat(editValue.value);
        if (type === 'income') data.include = editInclude.checked;
        localStorage.setItem(type+'s', JSON.stringify(type==='income'?incomes:expenses));
        modal.style.display = 'none';
        renderLists();
      };
      document.getElementById('cancelEdit').onclick = () => modal.style.display = 'none';
    };

    window.deleteItem = function(type, index) {
      const arr = type === 'income' ? incomes : expenses;
      if (confirm(`Delete "${arr[index].title}" (£${arr[index].amount.toFixed(2)})?`)) {
        arr.splice(index, 1);
        localStorage.setItem(type+'s', JSON.stringify(arr));
        renderLists();
      }
    };

    document.getElementById('addIncomeBtn').onclick = () => {
      const title = document.getElementById('incomeTitle').value.trim();
      const amount = parseFloat(document.getElementById('incomeAmount').value);
      if (!title || isNaN(amount)) return alert('Enter valid income');
      incomes.push({ title, amount, include: document.getElementById('incomeInclude').checked });
      localStorage.setItem('incomes', JSON.stringify(incomes));
      renderLists();
    };

    document.getElementById('addExpenseBtn').onclick = () => {
      const title = document.getElementById('expenseTitle').value.trim();
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      if (!title || isNaN(amount)) return alert('Enter valid expense');
      expenses.push({ title, amount });
      localStorage.setItem('expenses', JSON.stringify(expenses));
      renderLists();
    };

    renderLists();
  </script>
</body>
</html>
