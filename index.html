<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ventsharm Budget</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#000000" />
<link rel="icon" href="Icon-192.png" />
<style>
:root{
  --bg:#f5f6f8;--card:#fff;--text:#111;--muted:#6b7280;
  --b:#e5e7eb;--b2:#d1d5db;--pri:#0d6efd;--pri2:#00aaff;
  --shadow:0 8px 24px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);color:var(--text);
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;padding:20px;
}
.card{
  background:var(--card);
  border-radius:22px;
  box-shadow:var(--shadow);
  padding:26px 22px;
  width:100%;max-width:420px;
  box-sizing:border-box;
}
h1{font-size:1.4rem;text-align:center;margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:8px}
h1 img{width:28px;height:28px}
input,button,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--b);font-size:1rem;margin-top:10px}
button{cursor:pointer;font-weight:600}
.primary{background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff;border:none}
.gray{background:#f3f4f6}
.hidden{display:none}
.note{text-align:center;color:var(--muted);font-size:.9rem;margin-top:12px}
.tabs{display:flex;gap:8px;margin-top:18px}
.tab{flex:1;text-align:center;padding:10px;border:1px solid var(--b2);border-radius:12px;cursor:pointer;user-select:none;touch-action:manipulation;}
.tab.active{background:#eef6ff;border-color:#b6dbff;color:#064d96}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.row{display:flex;gap:10px;margin-top:10px}
.totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:14px}
.totals .box{background:#f7f7f9;border:1px solid var(--b);border-radius:12px;padding:12px;text-align:center}
.totals b{display:block;margin-top:4px}
.item{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--b)}
.item:last-child{border-bottom:none}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:30}
.modal{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px;max-width:420px;width:100%}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h1><img src="Icon-192.png"> Ventsharm Budget</h1>
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button id="loginBtn" class="primary">Login / Register</button>
  <button id="forgotBtn" class="gray">Forgot Password</button>
  <button id="verifyBtn" class="gray hidden">Resend Verification</button>
  <p class="note">Sign in or create an account to access your budget.</p>
</div>

<div class="card hidden" id="appCard">
  <div class="header" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
    <h1 style="margin:0;display:flex;align-items:center;gap:8px"><img src="Icon-192.png"> Ventsharm Budget</h1>
    <button id="logoutBtn" class="gray" style="width:auto">Logout</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="inc">Incomes</div>
    <div class="tab" data-tab="exp">Expenses</div>
    <div class="tab" data-tab="ov">Overview</div>
  </div>

  <div class="grid2">
    <input id="title" placeholder="Title (e.g. Salary, Rent)">
    <input id="amount" type="number" placeholder="Amount">
  </div>

  <div class="row">
    <select id="kind">
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <button id="addBtn" class="primary" style="flex:1">Add</button>
  </div>

  <div class="totals">
    <div class="box"><span class="muted">Income</span><b id="tInc">£0.00</b></div>
    <div class="box"><span class="muted">Expense</span><b id="tExp">£0.00</b></div>
    <div class="box"><span class="muted">Available</span><b id="tAvail">£0.00</b></div>
  </div>

  <div id="pane-inc" style="margin-top:10px"></div>
  <div id="pane-exp" class="hidden" style="margin-top:10px"></div>
  <div id="pane-ov" class="hidden note" style="margin-top:10px"></div>

  <p class="note">Synced via Firebase. Cached offline; 0 reads on refresh.</p>
</div>

<!-- Modal for editing -->
<div id="modalBack" class="modal-back">
  <div class="modal">
    <h3>Edit Entry</h3>
    <input id="mTitleInput" placeholder="Title">
    <input id="mAmountInput" type="number" placeholder="Amount" style="margin-top:10px">
    <div class="row" style="margin-top:12px">
      <button id="mSave" class="primary" style="flex:1">Save</button>
      <button id="mDelete" class="gray">Delete</button>
      <button id="mClose" class="gray">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, sendEmailVerification, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyCdqBDusmELyZ6S6OeiUX_I_POjydy-dN4",
  authDomain:"budget-app-283de.firebaseapp.com",
  projectId:"budget-app-283de",
  storageBucket:"budget-app-283de.firebasestorage.app",
  messagingSenderId:"162369707369",
  appId:"1:162369707369:web:3faa7f002f8ba22dc0f1f8"
});
const auth=getAuth(app); const db=getFirestore(app);
await setPersistence(auth,browserLocalPersistence);

const loginCard=document.getElementById("loginCard");
const appCard=document.getElementById("appCard");
const email=document.getElementById("email");
const pass=document.getElementById("password");
const loginBtn=document.getElementById("loginBtn");
const forgotBtn=document.getElementById("forgotBtn");
const verifyBtn=document.getElementById("verifyBtn");
const logoutBtn=document.getElementById("logoutBtn");
const LS="vb_cache_v5";
let cache=JSON.parse(localStorage.getItem(LS)||'{"entries":[],"uid":null}');
let UID=cache.uid;function save(){localStorage.setItem(LS,JSON.stringify(cache));}
function fmt(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}

loginBtn.onclick=async()=>{
  if(!email.value||!pass.value){alert("Enter email and password");return;}
  try{
    await signInWithEmailAndPassword(auth,email.value,pass.value);
  }catch{
    const u=await createUserWithEmailAndPassword(auth,email.value,pass.value);
    await sendEmailVerification(u.user);
    alert("Account created! Check your email for verification.");
  }
};

forgotBtn.onclick=async()=>{
  if(!email.value)return alert("Enter your email first");
  await sendPasswordResetEmail(auth,email.value);
  alert("Password reset email sent!");
};

verifyBtn.onclick=async()=>{
  if(auth.currentUser){await sendEmailVerification(auth.currentUser);alert("Verification email sent again!");}
};

logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,async u=>{
  if(u && u.emailVerified){
    UID=u.uid;cache.uid=UID;save();
    loginCard.classList.add("hidden");
    appCard.classList.remove("hidden");
    const q=await getDocs(collection(db,"users",UID,"entries"));
    cache.entries=q.docs.map(d=>d.data());save();render();
  }else{
    UID=null;cache.uid=null;save();
    loginCard.classList.remove("hidden");
    appCard.classList.add("hidden");
    verifyBtn.classList.toggle("hidden",!u);
  }
});

/* --- FIXED TAB SYSTEM --- */
const panes={inc:document.getElementById("pane-inc"),exp:document.getElementById("pane-exp"),ov:document.getElementById("pane-ov")};
function setTab(id){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active",t.dataset.tab===id);
  });
  Object.values(panes).forEach(p=>p.classList.add("hidden"));
  (panes[id]||panes.inc).classList.remove("hidden");
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click",e=>{
    e.preventDefault();e.stopPropagation();setTab(t.dataset.tab);
  },{passive:true});
});
setTab("inc");
/* --- END FIXED TAB SYSTEM --- */

const tInc=document.getElementById("tInc"),tExp=document.getElementById("tExp"),tAvail=document.getElementById("tAvail");
function render(){
  panes.inc.innerHTML="";panes.exp.innerHTML="";
  cache.entries.filter(e=>e.kind==="income").forEach(e=>panes.inc.append(row(e)));
  cache.entries.filter(e=>e.kind==="expense").forEach(e=>panes.exp.append(row(e)));
  const inc=cache.entries.filter(e=>e.kind==="income").reduce((a,b)=>a+Number(b.amount||0),0);
  const exp=cache.entries.filter(e=>e.kind==="expense").reduce((a,b)=>a+Number(b.amount||0),0);
  tInc.textContent="£"+fmt(inc);tExp.textContent="£"+fmt(exp);tAvail.textContent="£"+fmt(inc-exp);
}
function row(e){
  const el=document.createElement("div");
  el.className="item";
  el.innerHTML=`<div>${e.title}</div><div>£${fmt(e.amount)}</div><button class='gray' data-a='edit'>Edit</button><button class='gray' data-a='del'>Del</button>`;
  el.querySelector("[data-a='edit']").onclick=()=>openEdit(e.id);
  el.querySelector("[data-a='del']").onclick=()=>del(e.id);
  return el;
}
const title=document.getElementById("title"),amount=document.getElementById("amount"),kind=document.getElementById("kind");
document.getElementById("addBtn").onclick=async()=>{
  if(!title.value||!amount.value)return;
  const e={id:crypto.randomUUID(),title:title.value,amount:Number(amount.value),kind:kind.value};
  cache.entries.unshift(e);save();render();
  title.value="";amount.value="";
  if(UID)await setDoc(doc(db,"users",UID,"entries",e.id),e);
};

let editing=null;
const modalBack=document.getElementById("modalBack");
function openEdit(id){
  const e=cache.entries.find(x=>x.id===id);
  if(!e)return;
  editing=id;
  document.getElementById("mTitleInput").value=e.title;
  document.getElementById("mAmountInput").value=e.amount;
  modalBack.style.display="flex";
}
document.getElementById("mClose").onclick=()=>modalBack.style.display="none";
document.getElementById("mSave").onclick=async()=>{
  const e=cache.entries.find(x=>x.id===editing);
  if(!e)return;
  e.title=document.getElementById("mTitleInput").value;
  e.amount=Number(document.getElementById("mAmountInput").value);
  save();render();modalBack.style.display="none";
  if(UID)await setDoc(doc(db,"users",UID,"entries",e.id),e);
};
document.getElementById("mDelete").onclick=async()=>{
  cache.entries=cache.entries.filter(x=>x.id!==editing);
  save();render();modalBack.style.display="none";
  if(UID)await deleteDoc(doc(db,"users",UID,"entries",editing));
};
render();

if("serviceWorker"in navigator){
  navigator.serviceWorker.register("/Socialcreator-manifest/service-worker.js",{scope:"/Socialcreator-manifest/"});
}
</script>
</body>
</html>
