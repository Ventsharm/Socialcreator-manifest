<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Budget Planner</title>
<link rel="icon" href="Icon-192.png" />
<style>
:root{
 --bg:#f5f6fa;--card:#fff;--text:#111;--muted:#6b7280;
 --blue:#1677ff;--blue2:#0d6efd;--danger:#ef4444;
 --shadow:0 10px 30px rgba(0,0,0,.08);--radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:40px auto;padding:12px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
h1{text-align:center;font-size:32px;margin:0 0 20px}
.pilltabs{display:flex;gap:10px;justify-content:center;margin:14px 0 18px}
.pilltabs button{padding:12px 18px;border-radius:999px;border:1px solid #e5e7eb;background:#f1f5f9;font-weight:700;cursor:pointer}
.pilltabs button.active{background:var(--blue);border-color:var(--blue);color:#fff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
input,button{font-size:16px}
input{width:100%;padding:12px 14px;border:1px solid #d1d5db;border-radius:12px}
.btn{border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn-blue{background:linear-gradient(90deg,var(--blue2),#2aa0ff);color:#fff}
.btn-gray{background:#e5e7eb}
.btn-danger{background:var(--danger);color:#fff}
.list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
.item{border:1px solid #eef2f7;border-radius:14px;background:#fff;padding:12px;display:flex;align-items:center;gap:10px}
.item .name{font-weight:700}
.item .amt{margin-left:auto;font-weight:800}
.item .actions{display:flex;gap:8px;margin-left:10px}
.kpi{padding:16px;border-radius:14px;background:#f8fafc;text-align:center}
.kpi h3{margin:0 0 4px;font-size:14px;color:var(--muted)}
.kpi .val{font-size:22px;font-weight:800}
.footer{margin-top:14px;text-align:center;color:#6b7280;font-size:14px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:50;padding:16px}
.overlay.show{display:grid}
.modal{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:22px;width:min(500px,100%)}
.modal h2{margin:0 0 12px;text-align:center}
.stack{display:flex;flex-direction:column;gap:10px}
.seg{display:flex;gap:8px;margin-bottom:10px}
.seg button{flex:1;border:1px solid #e5e7eb;border-radius:12px;background:#f1f5f9;padding:10px;font-weight:700}
.seg button.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.note{font-size:14px;background:#fff7ed;padding:8px;border-radius:10px;color:#92400e}
</style>
</head>
<body>

<div class="wrap" id="planner" style="display:none;">
  <div class="card">
    <h1>Budget Planner</h1>

    <div class="pilltabs">
      <button class="tabBtn active" data-tab="incomes">Incomes</button>
      <button class="tabBtn" data-tab="expenses">Expenses</button>
      <button class="tabBtn" data-tab="overview">Overview</button>
    </div>

    <section id="tab-incomes">
      <h3>Income Sources</h3>
      <div class="row">
        <input id="incomeName" placeholder="Income name e.g. Cashier or Benefit" />
        <input id="incomeAmt" type="number" step="0.01" placeholder="Amount e.g. 1200" />
      </div>
      <label><input type="checkbox" id="incomeInclude" checked> Include in available income</label>
      <div class="row" style="margin-top:10px">
        <button id="addIncome" class="btn btn-blue">Add Income</button>
        <button id="resetLocal" class="btn btn-gray">Reset</button>
      </div>
      <div class="list" id="incomeList"></div>
    </section>

    <section id="tab-expenses" style="display:none;">
      <h3>Expenses</h3>
      <div class="row">
        <input id="expenseName" placeholder="Bill / Subscription e.g. Rent" />
        <input id="expenseAmt" type="number" step="0.01" placeholder="Amount e.g. 500" />
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addExpense" class="btn btn-blue">Add Bill</button>
        <button id="resetLocal2" class="btn btn-gray">Reset</button>
      </div>
      <div class="list" id="expenseList"></div>
    </section>

    <section id="tab-overview" style="display:none;">
      <div class="row3">
        <div class="kpi"><h3>Total Income (All)</h3><div id="kpiIncome" class="val">£0.00</div></div>
        <div class="kpi" style="background:#f3f0ff"><h3 style="color:#6d28d9">Available Income</h3><div id="kpiAvail" class="val" style="color:#6d28d9">£0.00</div></div>
        <div class="kpi" style="background:#fff1f2"><h3 style="color:#dc2626">Expenses</h3><div id="kpiExpense" class="val" style="color:#dc2626">£0.00</div></div>
      </div>
    </section>

    <button id="logout" class="btn btn-gray" style="width:100%;margin-top:16px;">Logout</button>
    <div class="footer">Synced via Firebase. Cached offline; <span id="reads">0</span> reads on refresh.</div>
  </div>
</div>

<!-- AUTH -->
<div class="overlay show" id="authScreen">
  <div class="modal">
    <h2>Budget Planner Login</h2>
    <div class="seg">
      <button id="segLogin" class="active">Login</button>
      <button id="segRegister">Register</button>
      <button id="segReset">Forgot</button>
    </div>

    <div id="boxLogin" class="stack">
      <input id="loginEmail" placeholder="Email" />
      <input id="loginPass" type="password" placeholder="Password" />
      <button id="doLogin" class="btn btn-blue">Login</button>
    </div>

    <div id="boxRegister" class="stack" style="display:none">
      <input id="regEmail" placeholder="Email" />
      <input id="regPass" type="password" placeholder="Password (min 6)" />
      <button id="doRegister" class="btn btn-blue">Create Account</button>
      <div class="note">After registering we’ll send a verification email. Please verify before login.</div>
    </div>

    <div id="boxReset" class="stack" style="display:none">
      <input id="rstEmail" placeholder="Email" />
      <button id="doReset" class="btn btn-blue">Send Reset Link</button>
    </div>

    <p id="authMsg" style="text-align:center;color:#6b7280;"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence,
         signInWithEmailAndPassword, createUserWithEmailAndPassword, sendEmailVerification,
         sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const config = {
  apiKey:"AIzaSyCdqBDusmELyZ6S6OeiUX_I_POjydy-dN4",
  authDomain:"budget-app-283de.firebaseapp.com",
  projectId:"budget-app-283de",
  storageBucket:"budget-app-283de.firebasestorage.app",
  messagingSenderId:"162369707369",
  appId:"1:162369707369:web:3faa7f002f8ba22dc0f1f8"
};
const app = initializeApp(config);
const auth = getAuth(app);
const db = getFirestore(app);
await setPersistence(auth,browserLocalPersistence);

const $=s=>document.querySelector(s);
const tabs={incomes:$("#tab-incomes"),expenses:$("#tab-expenses"),overview:$("#tab-overview")};
document.querySelectorAll(".tabBtn").forEach(b=>{
  b.onclick=()=>{document.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  for(let k in tabs)tabs[k].style.display=k===b.dataset.tab?"block":"none";}
});

let me=null,state={incomes:[],expenses:[]},reads=0;
const LC={key:u=>"bp_"+u.uid,get:u=>JSON.parse(localStorage.getItem("bp_"+u.uid)||"{}"),set(u,d){localStorage.setItem("bp_"+u.uid,JSON.stringify(d));}};
const fmt=n=>"£"+(Number(n||0)).toFixed(2);
function calc(){
 const incAll=state.incomes.reduce((s,x)=>s+Number(x.amount||0),0);
 const incInc=state.incomes.filter(x=>x.include).reduce((s,x)=>s+Number(x.amount||0),0);
 const expAll=state.expenses.reduce((s,x)=>s+Number(x.amount||0),0);
 $("#kpiIncome").textContent=fmt(incAll);
 $("#kpiExpense").textContent=fmt(expAll);
 $("#kpiAvail").textContent=fmt(incInc-expAll);
}
function render(){
 const iL=$("#incomeList"),eL=$("#expenseList");iL.innerHTML=eL.innerHTML="";
 state.incomes.forEach(x=>{
   const d=document.createElement("div");d.className="item";
   const c=document.createElement("input");c.type="checkbox";c.checked=x.include;
   c.onchange=()=>{x.include=c.checked;save();};
   d.append(c,Object.assign(document.createElement("div"),{className:"name",textContent:x.name}),
     Object.assign(document.createElement("div"),{className:"amt",textContent:fmt(x.amount)}));
   ebtn("Edit",()=>edit("income",x),d); ebtn("Delete",()=>del("income",x),d);
   iL.append(d);
 });
 state.expenses.forEach(x=>{
   const d=document.createElement("div");d.className="item";
   d.append(Object.assign(document.createElement("div"),{className:"name",textContent:x.name}),
            Object.assign(document.createElement("div"),{className:"amt",textContent:fmt(x.amount)}));
   ebtn("Edit",()=>edit("expense",x),d); ebtn("Delete",()=>del("expense",x),d);
   eL.append(d);
 });
 calc();
}
function ebtn(txt,fn,par){const b=document.createElement("button");b.textContent=txt;b.className=txt==="Delete"?"btn btn-danger":"btn btn-blue";b.onclick=fn;par.append(b);}
function del(t,x){if(confirm("Delete "+x.name+"?")){state[t+"s"]=state[t+"s"].filter(i=>i.id!==x.id);save();}}
function save(){if(!me)return;const data={incomes:state.incomes,expenses:state.expenses,updatedAt:serverTimestamp()};setDoc(doc(db,"budgets",me.uid),data,{merge:true});LC.set(me,data);render();}
async function load(){const c=LC.get(me);if(c.incomes)state=c;render();const s=await getDoc(doc(db,"budgets",me.uid));reads++;$("#reads").textContent=reads;if(s.exists()){state=s.data();LC.set(me,state);render();}}
$("#addIncome").onclick=()=>{const n=$("#incomeName").value.trim(),a=parseFloat($("#incomeAmt").value),inc=$("#incomeInclude").checked;if(!n||!isFinite(a))return alert("Enter name/amount");state.incomes.push({id:crypto.randomUUID(),name:n,amount:a,include:inc});save();$("#incomeName").value=$("#incomeAmt").value="";};
$("#addExpense").onclick=()=>{const n=$("#expenseName").value.trim(),a=parseFloat($("#expenseAmt").value);if(!n||!isFinite(a))return alert("Enter name/amount");state.expenses.push({id:crypto.randomUUID(),name:n,amount:a});save();$("#expenseName").value=$("#expenseAmt").value="";};
$("#resetLocal").onclick=$("#resetLocal2").onclick=()=>{if(me){localStorage.removeItem("bp_"+me.uid);location.reload();}};
$("#logout").onclick=()=>signOut(auth);

$("#segLogin").onclick=()=>show("login");$("#segRegister").onclick=()=>show("register");$("#segReset").onclick=()=>show("reset");
function show(w){$("#boxLogin").style.display=w==="login"?"flex":"none";$("#boxRegister").style.display=w==="register"?"flex":"none";$("#boxReset").style.display=w==="reset"?"flex":"none";
["segLogin","segRegister","segReset"].forEach(id=>$("#"+id).classList.toggle("active",id==="seg"+w[0].toUpperCase()+w.slice(1)));}
$("#doLogin").onclick=async()=>{try{const e=$("#loginEmail").value,p=$("#loginPass").value;const u=await signInWithEmailAndPassword(auth,e,p);if(!u.user.emailVerified){await sendEmailVerification(u.user);$("#authMsg").textContent="Verify your email first.";}else $("#authScreen").classList.remove("show");}catch(x){$("#authMsg").textContent=x.message;}};
$("#doRegister").onclick=async()=>{try{const e=$("#regEmail").value,p=$("#regPass").value;const u=await createUserWithEmailAndPassword(auth,e,p);await sendEmailVerification(u.user);$("#authMsg").textContent="Verification sent. Confirm then login.";}catch(x){$("#authMsg").textContent=x.message;}};
$("#doReset").onclick=async()=>{try{await sendPasswordResetEmail(auth,$("#rstEmail").value);$("#authMsg").textContent="Password reset email sent.";}catch(x){$("#authMsg").textContent=x.message;}};

onAuthStateChanged(auth,async u=>{
 if(u&&u.emailVerified){me=u;$("#authScreen").classList.remove("show");$("#planner").style.display="block";await load();}
 else {$("#planner").style.display="none";$("#authScreen").classList.add("show");}
});
function edit(t,x){const n=prompt("Edit name",x.name);if(!n)return;const a=parseFloat(prompt("Edit amount",x.amount));if(isFinite(a)){x.name=n;x.amount=a;save();}}
</script>
</body>
</html>
